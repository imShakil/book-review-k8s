name: Build & Push Docker Images

on:
  push:
    branches:
      - main
      - dev
      - staging
      - prod
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      source_repo:
        description: "GitHub repo that contains the Dockerfiles (org/name)"
        required: true
        default: "pravinmishraaws/book-review-app"
      source_ref:
        description: "Branch or tag"
        required: false
        default: "main"
      docker_paths:
        description: "Folders containing Dockerfiles (space separated), e.g., backend frontend"
        required: true
        default: "backend frontend"
      docker_images:
        description: "Docker image names (same order as paths), e.g., backend frontend"
        required: true
        default: "book-review-backend book-review-frontend"
      registry:
        description: "Docker registry"
        required: false
        default: "docker.io"

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.source_repo || 'pravinmishraaws/book-review-app' }}
          ref: ${{ github.event.inputs.source_ref || 'main' }}
          path: repo-src

      - name: Build matrix
        id: matrix
        shell: bash
        env:
          INPUT_PATHS: ${{ github.event.inputs.docker_paths || 'backend frontend' }}
          INPUT_IMAGES: ${{ github.event.inputs.docker_images || 'book-review-backend book-review-frontend' }}
          CLONE_DIR: repo-src
        run: |
          set -euo pipefail

          normalize_list() {
            local raw="$1"
            raw="${raw//$'\r'/}"
            printf '%s\n' "$raw" | tr -s '[:space:]' '\n' | sed '/^$/d'
          }

          mapfile -t PATHS < <(normalize_list "$INPUT_PATHS")
          mapfile -t IMAGES < <(normalize_list "$INPUT_IMAGES")

          if [ "${#PATHS[@]}" -ne "${#IMAGES[@]}" ]; then
            echo "Error: paths count (${#PATHS[@]}) does not match images count (${#IMAGES[@]})"
            exit 1
          fi

          # Determine tag: use git ref
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]] || [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            IMAGE_TAG="${GITHUB_REF#refs/tags/}"
          else
            IMAGE_TAG="${GITHUB_REF#refs/heads/}"
          fi

          items=()
          for i in "${!PATHS[@]}"; do
            path="${PATHS[$i]%/}"
            image="${IMAGES[$i]}"
            items+=( "$(jq -n --arg p "$path" --arg i "$image" --arg t "$IMAGE_TAG" '{path:$p,image:$i,tag:$t}')" )
          done

          matrix_json="$(printf '%s\n' "${items[@]}" | jq -s '.')"

          echo "matrix<<EOF" >> "$GITHUB_OUTPUT"
          echo "$matrix_json" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "matrix prepared: $matrix_json"

  build-and-push:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}

    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.source_repo || 'pravinmishraaws/book-review-app' }}
          ref: ${{ github.event.inputs.source_ref || 'main' }}
          path: repo-src

      - name: Login to Docker registry
        run: |
          echo "${DOCKER_PASS}" | docker login \
            -u "${DOCKER_USER}" \
            --password-stdin
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASS: ${{ secrets.DOCKER_PASS }}

      - name: Build image
        run: |
          FULL_IMAGE="${DOCKER_USER}/${{ matrix.image }}:${{ matrix.tag }}"
          echo "Building image $FULL_IMAGE from repo-src/${{ matrix.path }}"
          docker build -t "$FULL_IMAGE" "repo-src/${{ matrix.path }}"
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}

      - name: Push image
        run: |
          FULL_IMAGE="${DOCKER_USER}/${{ matrix.image }}:${{ matrix.tag }}"
          echo "Pushing image $FULL_IMAGE"
          docker push "$FULL_IMAGE"
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}